<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ• ×”×¢×¨×›×ª ×–××Ÿ ×—×–×¨×” ××©×‘×ª</title>

    <meta name="description" content="××¢×¨×›×ª ×—×›××” ×¢× ×œ××™×“×ª ××›×•× ×” ×œ×—×™×–×•×™ ×–××Ÿ ×—×–×¨×” ××‘×™×ª ×”×›× ×¡×ª">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="×–××Ÿ ×—×–×¨×” ××©×‘×ª">

    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='80' font-size='80'%3EğŸ•%3C/text%3E%3C/svg%3E">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .prediction-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            position: relative;
        }

        .loading-indicator {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-indicator.loading::before {
            content: "âŸ³";
            animation: spin 1s linear infinite;
        }

        .parsha-name {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .verses-count {
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .time-display {
            font-size: 3em;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .duration {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .confidence {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            padding: 5px 15px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .ai-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 20px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .ai-indicator::before {
            content: "ğŸ§ ";
        }

        .section-title {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            margin-top: 10px;
        }

        .history-item {
            padding: 15px;
            border-right: 4px solid #667eea;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .history-item:hover {
            background: #f0f0f0;
            transform: translateX(-5px);
        }

        .history-item:active {
            transform: scale(0.98);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .history-parsha {
            font-weight: bold;
            color: #667eea;
        }

        .history-date {
            color: #999;
            font-size: 0.9em;
        }

        .history-times {
            color: #666;
            font-size: 0.9em;
        }

        .error-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-right: 10px;
        }

        .error-positive {
            background: #ffe0e0;
            color: #d32f2f;
        }

        .error-negative {
            background: #e0f2f1;
            color: #00897b;
        }

        .error-zero {
            background: #e8f5e9;
            color: #43a047;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #999;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .learning-progress {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .learning-title {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .offset-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .offset-item:last-child {
            border-bottom: none;
        }

        .offset-label {
            color: #666;
        }

        .offset-value {
            font-weight: bold;
            color: #667eea;
        }

        .hidden {
            display: none;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .refresh-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

    .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
.modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 1000;
    justify-content: center;
    align-items: center;
}

        .modal-overlay.active {
            display: flex;
        }
.modal-overlay.active {
    display: flex;
}

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
.modal-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

        .modal-header {
            font-size: 1.8em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 25px;
            text-align: center;
        }
.modal-header {
    font-size: 1.8em;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 25px;
    text-align: center;
}

        .modal-input-group {
            margin-bottom: 20px;
        }
.modal-input-group {
    margin-bottom: 20px;
}

        .modal-input-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }
.modal-input-group label {
    display: block;
    margin-bottom: 8px;
    color: #555;
    font-weight: 600;
}

        .modal-input-group select,
        .modal-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
.modal-input-group select {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1em;
    transition: border-color 0.3s;
}

        .modal-input-group select:focus,
        .modal-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
.modal-input-group select:focus {
    outline: none;
    border-color: #667eea;
}

        .modal-input-group .readonly-field {
            background: #f5f5f5;
            color: #666;
            cursor: not-allowed;
        }
.modal-input-group input[type="time"] {
    width: 100%;
    padding: 12px;
    border: 2px solid #e0e0e0;
    border-radius: 10px;
    font-size: 1em;
    transition: border-color 0.3s;
}

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
.modal-input-group input[type="time"]:focus {
    outline: none;
    border-color: #667eea;
}

        .modal-btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
.display-field {
    background: #f9f9f9;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #e8e8e8;
    font-size: 1em;
    color: #333;
    font-weight: 500;
}

        .modal-btn:active {
            transform: scale(0.98);
        }
.modal-buttons {
    display: flex;
    gap: 10px;
    margin-top: 25px;
}

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
.modal-btn {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 10px;
    font-size: 1.1em;
    font-weight: bold;
    cursor: pointer;
    transition: transform 0.2s;
}

        .modal-btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
.modal-btn:active {
    transform: scale(0.98);
}

.modal-btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.modal-btn-secondary {
    background: #f5f5f5;
    color: #333;
}

.info-text {
    font-size: 0.9em;
    color: #999;
    margin-top: 5px;
}

        .info-text {
            font-size: 0.9em;
            color: #999;
            margin-top: 5px;
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ• ×”×¢×¨×›×ª ×–××Ÿ ×—×–×¨×” ××©×‘×ª</h1>
            <p>××¢×¨×›×ª ×—×›××” ×¢× ×œ××™×“×ª ××›×•× ×” ğŸ§ </p>
        </div>

        <div class="card prediction-card">
            <div class="loading-indicator" id="loadingIndicator"></div>

            <div class="parsha-name" id="currentParsha">×˜×•×¢×Ÿ...</div>
            <div class="verses-count" id="versesCount">- ×¤×¡×•×§×™×</div>
            <div class="time-display" id="predictedTime">--:--</div>
            <div class="duration" id="duration">××©×š ××©×•×¢×¨: -- ×“×§×•×ª</div>
            <div class="confidence" id="confidence">×¨××ª ×‘×™×˜×—×•×Ÿ: × ××•×›×”</div>
            <div class="ai-indicator" id="aiIndicator">×”××¢×¨×›×ª ×œ×•××“×ª ××”×›×™×•×•× ×•× ×™× ×©×œ×š</div>

            <button class="refresh-btn" onclick="loadCurrentParsha(true)">ğŸ”„ ×¨×¢× ×Ÿ ×œ×¤×¨×©×” ×”×‘××”</button>
        </div>

        <div class="card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('calibrate')">×›×™×•×•× ×•×Ÿ</button>
                <button class="tab" onclick="switchTab('history')">×”×™×¡×˜×•×¨×™×”</button>
                <button class="tab" onclick="switchTab('parshiot')">×¤×¨×©×•×ª</button>
                <button class="tab" onclick="switchTab('settings')">×”×’×“×¨×•×ª</button>
            </div>

            <div id="calibrateTab">
                <div class="section-title">ğŸ”§ ×›×™×•×•× ×•×Ÿ ×–××Ÿ ×—×–×¨×”</div>

                <div class="input-group">
                    <label for="actualTime">××ª×™ ×‘×¤×•×¢×œ ×—×–×¨×ª?</label>
                    <input type="time" id="actualTime" value="10:15">
                </div>

                <button class="btn btn-primary" onclick="saveCalibration()">ğŸ’¾ ×©××•×¨ ×›×™×•×•× ×•×Ÿ</button>

                <div class="learning-progress">
                    <div class="learning-title">ğŸ§  ××” ×”××¢×¨×›×ª ×œ××“×” ×¢×“ ×›×”</div>
                    <div class="offset-item">
                        <span class="offset-label">×§×™×–×•×– ×’×œ×•×‘×œ×™</span>
                        <span class="offset-value" id="globalOffsetDisplay">0 ×“×§'</span>
                    </div>
                    <div class="offset-item">
                        <span class="offset-label">×¤×¨×©×•×ª ×§×¦×¨×•×ª (&lt;80)</span>
                        <span class="offset-value" id="shortOffsetDisplay">0 ×“×§'</span>
                    </div>
                    <div class="offset-item">
                        <span class="offset-label">×¤×¨×©×•×ª ×‘×™× ×•× ×™×•×ª (80-140)</span>
                        <span class="offset-value" id="mediumOffsetDisplay">0 ×“×§'</span>
                    </div>
                    <div class="offset-item">
                        <span class="offset-label">×¤×¨×©×•×ª ××¨×•×›×•×ª (140-180)</span>
                        <span class="offset-value" id="longOffsetDisplay">0 ×“×§'</span>
                    </div>
                    <div class="offset-item">
                        <span class="offset-label">×¤×¨×©×•×ª ××¨×•×›×•×ª ×××•×“ (&gt;180)</span>
                        <span class="offset-value" id="veryLongOffsetDisplay">0 ×“×§'</span>
                    </div>
                </div>

                <button class="btn btn-secondary" onclick="resetData()">ğŸ”„ ××™×¤×•×¡ × ×ª×•× ×™×</button>

            </div>

            <div id="historyTab" class="hidden">
                <div class="section-title">ğŸ“Š ×”×™×¡×˜×•×¨×™×™×ª ×›×™×•×•× ×•× ×™×</div>
                <div id="historyList"></div>
            </div>

            <div id="parshiotTab" class="hidden">
                <div class="section-title">ğŸ“– ×¨×©×™××ª ×¤×¨×©×•×ª ×”×©× ×”</div>
                <div id="parshiotList"></div>
            </div>

            <div id="settingsTab" class="hidden">
                <div class="section-title">âš™ï¸ ×”×’×“×¨×•×ª</div>

                <div class="input-group">
                    <label for="startTime">×©×¢×ª ×”×ª×—×œ×ª ×ª×¤×™×œ×”</label>
                    <input type="time" id="startTime" value="08:00" onchange="saveSettings()">
                </div>

                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="totalCalibrations">0</div>
                        <div class="stat-label">×›×™×•×•× ×•× ×™×</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="avgError">0</div>
                        <div class="stat-label">×“×™×•×§ ×××•×¦×¢ (×“×§')</div>
                    </div>
                </div>

                <div class="learning-progress" style="margin-top: 20px;">
                    <div class="learning-title">â„¹ï¸ ××™×š ×”××¢×¨×›×ª ×œ×•××“×ª?</div>
                    <p style="color: #666; font-size: 0.9em; line-height: 1.6;">
                        ×”××¢×¨×›×ª ××©×ª××©×ª ×‘××œ×’×•×¨×™×ª× ×œ××™×“×” ×©××ª×¢×“×›×Ÿ ××—×¨×™ ×›×œ ×›×™×•×•× ×•×Ÿ:
                        <br><br>
                        <strong>×§×™×–×•×– ×’×œ×•×‘×œ×™:</strong> ××©×¤×™×¢ ×¢×œ ×›×œ ×”×¤×¨×©×•×ª (30% ××”×©×’×™××”)
                        <br>
                        <strong>×§×™×–×•×– ×§×˜×’×•×¨×™×”:</strong> ××©×¤×™×¢ ×¨×§ ×¢×œ ×¤×¨×©×•×ª ×‘××•×ª×• ××•×¨×š (20% ××”×©×’×™××”)
                        <br><br>
                        ×›×›×œ ×©×ª×›×™×™×œ ×™×•×ª×¨, ×”×—×™×–×•×™×™× ×™×”×™×• ××“×•×™×§×™× ×™×•×ª×¨! ğŸ¯
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const PARSHIOT = {
            "×‘×¨××©×™×ª": 146, "× ×—": 153, "×œ×š ×œ×š": 126, "×•×™×¨×": 147,
            "×—×™×™ ×©×¨×”": 105, "×ª×•×œ×“×•×ª": 106, "×•×™×¦×": 148, "×•×™×©×œ×—": 153,
            "×•×™×©×‘": 112, "××§×¥": 146, "×•×™×’×©": 106, "×•×™×—×™": 85,
            "×©××•×ª": 124, "×•××¨×": 121, "×‘×": 105, "×‘×©×œ×—": 116,
            "×™×ª×¨×•": 72, "××©×¤×˜×™×": 118, "×ª×¨×•××”": 96, "×ª×¦×•×”": 101,
            "×›×™ ×ª×©×": 139, "×•×™×§×”×œ": 122, "×¤×§×•×“×™": 92, "×•×™×§×”×œ-×¤×§×•×“×™": 214,
            "×•×™×§×¨×": 111, "×¦×•": 97, "×©××™× ×™": 91, "×ª×–×¨×™×¢": 67,
            "××¦×•×¨×¢": 90, "×ª×–×¨×™×¢-××¦×•×¨×¢": 157, "××—×¨×™ ××•×ª": 80, "×§×“×•×©×™×": 64,
            "××—×¨×™ ××•×ª-×§×“×•×©×™×": 144, "×××•×¨": 124, "×‘×”×¨": 57, "×‘×—×•×§×ª×™": 78,
            "×‘×”×¨-×‘×—×•×§×ª×™": 135, "×‘××“×‘×¨": 159, "× ×©×": 176, "×‘×”×¢×œ×•×ª×š": 136,
            "×©×œ×—": 119, "×§×¨×—": 95, "×—×§×ª": 87, "×‘×œ×§": 104, "×—×§×ª-×‘×œ×§": 191,
            "×¤×™× ×—×¡": 168, "××˜×•×ª": 112, "××¡×¢×™": 132, "××˜×•×ª-××¡×¢×™": 244,
            "×“×‘×¨×™×": 105, "×•××ª×—× ×Ÿ": 122, "×¢×§×‘": 111, "×¨××”": 126,
            "×©×•×¤×˜×™×": 97, "×›×™ ×ª×¦×": 110, "×›×™ ×ª×‘×•×": 122, "× ×¦×‘×™×": 40,
            "×•×™×œ×š": 30, "× ×¦×‘×™×-×•×™×œ×š": 70, "×”××–×™× ×•": 52, "×•×–××ª ×”×‘×¨×›×”": 41
        };

        let currentParsha = null;
        let appData = {
            baseMinutesPerVerse: 0.918,
            globalOffset: 0,
            categoryOffsets: { short: 0, medium: 0, long: 0, very_long: 0 },
            startTime: "08:00",
            history: [],
            calibrationCount: 0,
            savedParsha: null,
            savedParshaDate: null
        };

        function loadData() {
            const saved = localStorage.getItem('shabbatReturnData');
            if (saved) appData = { ...appData, ...JSON.parse(saved) };
        }

        function saveData() {
            localStorage.setItem('shabbatReturnData', JSON.stringify(appData));
        }

        function getCategory(verses) {
            if (verses < 80) return 'short';
            if (verses < 140) return 'medium';
            if (verses < 180) return 'long';
            return 'very_long';
        }

        async function loadCurrentParsha(force = false) {
            const indicator = document.getElementById('loadingIndicator');

            // ×× ×œ× ×××œ×¦×™× ×¨×¢× ×•×Ÿ - ×‘×“×•×§ ×× ×™×© ×¤×¨×©×” ×©××•×¨×”
            if (!force && appData.savedParsha && appData.savedParshaDate) {
                const savedDate = new Date(appData.savedParshaDate);
                const now = new Date();
                const dayOfWeek = now.getDay();
                const lastSunday = new Date(now);
                lastSunday.setDate(now.getDate() - dayOfWeek);
                lastSunday.setHours(0, 0, 0, 0);

                if (savedDate >= lastSunday) {
                    currentParsha = appData.savedParsha;
                    indicator.textContent = 'ğŸ“Œ ×¤×¨×©×” × ×•×›×—×™×ª';
                    setTimeout(() => indicator.textContent = '', 3000);
                    updatePrediction();
                    return;
                }
            }

            // ×× ×”×’×¢× ×• ×œ×›××Ÿ - ×˜×•×¢×Ÿ ×¤×¨×©×” ×—×“×©×” (××• ×›×™ force=true ××• ×›×™ ×¢×‘×¨ ×©×‘×•×¢)
            indicator.textContent = force ? '××¢×“×›×Ÿ ×œ×¤×¨×©×” ×”×‘××”...' : '×˜×•×¢×Ÿ ×¤×¨×©×” ×—×“×©×”...';
            indicator.classList.add('loading');

            try {
                let response;
                try {
                    response = await fetch('https://www.hebcal.com/shabbat?cfg=json&geonameid=293397&M=on&lg=h');
                } catch (e) {
                    response = await fetch('https://corsproxy.io/?https://www.hebcal.com/shabbat?cfg=json&geonameid=293397&M=on&lg=h');
                }

                const data = await response.json();
                const parshaItem = data.items.find(item => item.category === 'parashat');

                if (parshaItem) {
                    let parshaName = parshaItem.hebrew.replace('×¤×¨×©×ª ', '').replace('Ö¾', '-');
                    currentParsha = parshaName;
                    appData.savedParsha = parshaName;
                    appData.savedParshaDate = new Date().toISOString();
                    saveData();

                    indicator.textContent = 'âœ“ ×¢×•×“×›×Ÿ';
                    indicator.classList.remove('loading');
                    setTimeout(() => indicator.textContent = '', 2000);
                    updatePrediction();
                } else {
                    throw new Error('×œ× × ××¦××” ×¤×¨×©×ª ×©×‘×•×¢');
                }
            } catch (error) {
                console.error('Error loading parsha:', error);
                indicator.textContent = 'âš ï¸ ×©×’×™××”';
                indicator.classList.remove('loading');
                document.getElementById('currentParsha').textContent = '×©×’×™××” ×‘×˜×¢×™× ×”';
                document.getElementById('versesCount').textContent = '×œ×—×¥ ×¨×¢× ×Ÿ ×œ× ×¡×•×ª ×©×•×‘';
            }
        }

        function calculatePrediction(parsha) {
            const verses = PARSHIOT[parsha];
            if (!verses) return null;
            const category = getCategory(verses);
            const categoryOffset = appData.categoryOffsets[category] || 0;
            const totalMinutes = (verses * appData.baseMinutesPerVerse) + appData.globalOffset + categoryOffset;
            const [startHour, startMin] = appData.startTime.split(':').map(Number);
            const startTotalMin = startHour * 60 + startMin;
            const endTotalMin = startTotalMin + Math.round(totalMinutes);
            const endHour = Math.floor(endTotalMin / 60);
            const endMin = endTotalMin % 60;
            return {
                time: `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`,
                duration: Math.round(totalMinutes),
                verses: verses,
                category: category
            };
        }

        function updatePrediction() {
            if (!currentParsha) return;
            const prediction = calculatePrediction(currentParsha);
            if (prediction) {
                document.getElementById('currentParsha').textContent = `×¤×¨×©×ª ${currentParsha}`;
                document.getElementById('versesCount').textContent = `${prediction.verses} ×¤×¡×•×§×™×`;
                document.getElementById('predictedTime').textContent = prediction.time;
                document.getElementById('duration').textContent = `××©×š ××©×•×¢×¨: ${prediction.duration} ×“×§×•×ª`;

                let confidence = '× ××•×›×” (×¦×¨×™×š ×¢×•×“ ×›×™×•×•× ×•× ×™×)';
                if (appData.calibrationCount >= 10) confidence = '×’×‘×•×”×” ğŸ¯';
                else if (appData.calibrationCount >= 5) confidence = '×‘×™× ×•× ×™×ª ğŸ“ˆ';
                else if (appData.calibrationCount >= 2) confidence = '× ××•×›×”-×‘×™× ×•× ×™×ª';
                document.getElementById('confidence').textContent = `×¨××ª ×‘×™×˜×—×•×Ÿ: ${confidence}`;

                if (appData.calibrationCount === 0) {
                    document.getElementById('aiIndicator').textContent = '×”××¢×¨×›×ª ××—×›×” ×œ×›×™×•×•× ×•×Ÿ ×¨××©×•×Ÿ';
                } else {
                    const totalOffset = Math.abs(appData.globalOffset + (appData.categoryOffsets[prediction.category] || 0));
                    document.getElementById('aiIndicator').textContent = `×”××¢×¨×›×ª ×œ××“×” ${totalOffset.toFixed(1)} ×“×§' ×ª×™×§×•×Ÿ (${appData.calibrationCount} ×›×™×•×•× ×•× ×™×)`;
                }
                updateLearningDisplay();
            }
        }

        function updateLearningDisplay() {
            document.getElementById('globalOffsetDisplay').textContent = `${appData.globalOffset >= 0 ? '+' : ''}${appData.globalOffset.toFixed(1)} ×“×§'`;
            document.getElementById('shortOffsetDisplay').textContent = `${appData.categoryOffsets.short >= 0 ? '+' : ''}${appData.categoryOffsets.short.toFixed(1)} ×“×§'`;
            document.getElementById('mediumOffsetDisplay').textContent = `${appData.categoryOffsets.medium >= 0 ? '+' : ''}${appData.categoryOffsets.medium.toFixed(1)} ×“×§'`;
            document.getElementById('longOffsetDisplay').textContent = `${appData.categoryOffsets.long >= 0 ? '+' : ''}${appData.categoryOffsets.long.toFixed(1)} ×“×§'`;
            document.getElementById('veryLongOffsetDisplay').textContent = `${appData.categoryOffsets.very_long >= 0 ? '+' : ''}${appData.categoryOffsets.very_long.toFixed(1)} ×“×§'`;
        }

        function saveCalibration() {
            if (!currentParsha) {
                alert('×× × ×”××ª×Ÿ ×œ×˜×¢×™× ×ª ×¤×¨×©×ª ×”×©×‘×•×¢');
                return;
            }
            const actualTime = document.getElementById('actualTime').value;
            if (!actualTime) {
                alert('× × ×œ×”×–×™×Ÿ ×–××Ÿ ×—×–×¨×” ×‘×¤×•×¢×œ');
                return;
            }
            const prediction = calculatePrediction(currentParsha);
            if (!prediction) return;
            const [predHour, predMin] = prediction.time.split(':').map(Number);
            const [actHour, actMin] = actualTime.split(':').map(Number);
            const errorMinutes = (actHour * 60 + actMin) - (predHour * 60 + predMin);
            const GLOBAL_RATE = 0.3;
            const CATEGORY_RATE = 0.2;
            appData.globalOffset += errorMinutes * GLOBAL_RATE;
            appData.categoryOffsets[prediction.category] += errorMinutes * CATEGORY_RATE;
            appData.calibrationCount++;
            appData.history.unshift({
                date: new Date().toISOString().split('T')[0],
                parsha: currentParsha,
                predicted: prediction.time,
                actual: actualTime,
                error: errorMinutes
            });
            if (appData.history.length > 52) appData.history = appData.history.slice(0, 52);
            saveData();
            updatePrediction();
            updateHistory();
            updateStats();
            alert(`âœ… ×›×™×•×•× ×•×Ÿ × ×©××¨ ×‘×”×¦×œ×—×”!\n\n×©×’×™××”: ${errorMinutes > 0 ? '+' : ''}${errorMinutes} ×“×§×•×ª\n\n×”××¢×¨×›×ª ×œ××“×” ×•×¢×“×›× ×” ××ª ×”×—×™×–×•×™×™× ×”×‘××™×! ğŸ§ `);
        }

// ========================================
// ×©×™× ××ª ×”×§×•×“ ×”×–×” ×‘××§×•× ×”×¤×•× ×§×¦×™×” updateHistory() ×”×§×™×™××ª
// ========================================

function updateHistory() {
    const historyList = document.getElementById('historyList');

    if (appData.history.length === 0) {
        historyList.innerHTML = `
            <button onclick="showAddCalibrationDialog()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-bottom: 20px;">
                â• ×”×•×¡×£ ×›×™×•×•× ×•×Ÿ ×™×©×Ÿ
            </button>
            <div class="empty-state">
                <p>××™×Ÿ ×¢×“×™×™×Ÿ ×”×™×¡×˜×•×¨×™×”</p>
                <p style="font-size: 0.9em; margin-top: 10px;">×”×ª×—×œ ×œ×›×™×™×œ ××ª ×”××¢×¨×›×ª ××• ×”×•×¡×£ ×›×™×•×•× ×•×Ÿ ×™×©×Ÿ</p>
            </div>
        `;
        return;
    }

    let html = `
        <button onclick="showAddCalibrationDialog()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-bottom: 20px;">
            â• ×”×•×¡×£ ×›×™×•×•× ×•×Ÿ ×™×©×Ÿ
        </button>
    `;

    html += appData.history.map((item, index) => {
        let errorClass = 'error-zero';
        if (item.error > 0) errorClass = 'error-positive';
        else if (item.error < 0) errorClass = 'error-negative';

        return `
            <div class="history-item" onclick="showHistoryOptions(${index})" style="cursor: pointer; transition: transform 0.2s;">
                <div class="history-item-header">
                    <span class="history-parsha">${item.parsha}</span>
                    <span class="history-date">${item.date}</span>
                </div>
                <div class="history-times">
                    ×—×™×–×•×™: ${item.predicted} | ×‘×¤×•×¢×œ: ${item.actual}
                    <span class="error-badge ${errorClass}">
                        ${item.error > 0 ? '+' : ''}${item.error} ×“×§'
                    </span>
                </div>
                <div style="font-size: 0.85em; color: #999; margin-top: 5px;">ğŸ‘† ×œ×—×¥ ×œ×¢×¨×™×›×” ××• ××—×™×§×”</div>
            </div>
        `;
    }).join('');

    historyList.innerHTML = html;
}

// ========================================
// ×¤×•× ×§×¦×™×” ×œ××—×™×§×ª ×¨×©×•××”
// ========================================

function showHistoryOptions(index) {
    const item = appData.history[index];

    const choice = confirm(
        `×¤×¨×©×ª ${item.parsha} (${item.date})\n` +
        `×—×™×–×•×™: ${item.predicted} | ×‘×¤×•×¢×œ: ${item.actual}\n` +
        `×©×’×™××”: ${item.error > 0 ? '+' : ''}${item.error} ×“×§×•×ª\n\n` +
        `×œ×—×¥ OK ×œ×¢×¨×™×›×”\n` +
        `×œ×—×¥ Cancel ×œ××—×™×§×”`
    );

    if (choice) {
        editHistoryItem(index);
    } else {
        const confirmDelete = confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×›×™×•×•× ×•×Ÿ?\n\n×¤×¨×©×ª ${item.parsha}\n\n×”×§×™×–×•×–×™× ×™×—×•×©×‘×• ××—×“×©!`);
        if (confirmDelete) {
            deleteHistoryItem(index);
        }
    }
}

// ========================================
// 3. ×¤×•× ×§×¦×™×” ×œ×”×•×¡×¤×ª ×›×™×•×•× ×•×Ÿ ×™×©×Ÿ
// ========================================

// ×ª××¨×™×›×™ ×©×‘×ª×•×ª ×œ×›×œ ×¤×¨×©×” (2024-2025)
const PARSHA_DATES = {
    "×‘×¨××©×™×ª": "2024-11-01",
    "× ×—": "2024-11-08",
    "×œ×š ×œ×š": "2024-11-15",
    "×•×™×¨×": "2024-11-09",
    "×—×™×™ ×©×¨×”": "2024-11-15",
    "×ª×•×œ×“×•×ª": "2024-11-22",
    "×•×™×¦×": "2024-11-29",
    "×•×™×©×œ×—": "2024-12-06",
    "×•×™×©×‘": "2024-12-13",
    "××§×¥": "2024-12-20",
    "×•×™×’×©": "2024-12-27",
    "×•×™×—×™": "2025-01-03",
    "×©××•×ª": "2025-01-10",
    "×•××¨×": "2025-01-17",
    "×‘×": "2025-01-24",
    "×‘×©×œ×—": "2025-01-31",
    "×™×ª×¨×•": "2025-02-07",
    "××©×¤×˜×™×": "2025-02-14",
    "×ª×¨×•××”": "2025-02-21",
    "×ª×¦×•×”": "2025-02-28",
    "×›×™ ×ª×©×": "2025-03-07",
    "×•×™×§×”×œ": "2025-03-14",
    "×¤×§×•×“×™": "2025-03-21",
    "×•×™×§×”×œ-×¤×§×•×“×™": "2025-03-14",
    "×•×™×§×¨×": "2025-03-28",
    "×¦×•": "2025-04-04",
    "×©××™× ×™": "2025-04-11",
    "×ª×–×¨×™×¢": "2025-04-18",
    "××¦×•×¨×¢": "2025-04-25",
    "×ª×–×¨×™×¢-××¦×•×¨×¢": "2025-04-18",
    "××—×¨×™ ××•×ª": "2025-05-02",
    "×§×“×•×©×™×": "2025-05-09",
    "××—×¨×™ ××•×ª-×§×“×•×©×™×": "2025-05-02",
    "×××•×¨": "2025-05-16",
    "×‘×”×¨": "2025-05-23",
    "×‘×—×•×§×ª×™": "2025-05-30",
    "×‘×”×¨-×‘×—×•×§×ª×™": "2025-05-23",
    "×‘××“×‘×¨": "2025-06-06",
    "× ×©×": "2025-06-13",
    "×‘×”×¢×œ×•×ª×š": "2025-06-20",
    "×©×œ×—": "2025-06-27",
    "×§×¨×—": "2025-07-04",
    "×—×§×ª": "2025-07-11",
    "×‘×œ×§": "2025-07-18",
    "×—×§×ª-×‘×œ×§": "2025-07-11",
    "×¤×™× ×—×¡": "2025-07-25",
    "××˜×•×ª": "2025-08-01",
    "××¡×¢×™": "2025-08-08",
    "××˜×•×ª-××¡×¢×™": "2025-08-01",
    "×“×‘×¨×™×": "2025-08-15",
    "×•××ª×—× ×Ÿ": "2025-08-22",
    "×¢×§×‘": "2025-08-29",
    "×¨××”": "2025-09-05",
    "×©×•×¤×˜×™×": "2025-09-12",
    "×›×™ ×ª×¦×": "2025-09-19",
    "×›×™ ×ª×‘×•×": "2025-09-26",
    "× ×¦×‘×™×": "2025-10-03",
    "×•×™×œ×š": "2025-10-10",
    "× ×¦×‘×™×-×•×™×œ×š": "2025-10-03",
    "×”××–×™× ×•": "2025-10-17",
    "×•×–××ª ×”×‘×¨×›×”": "2025-10-24"
    // 2024
    "×‘×¨××©×™×ª": "2024-11-02",
    "× ×—": "2024-11-09",
    "×œ×š ×œ×š": "2024-11-16",
    "×•×™×¨×": "2024-11-23",
    "×—×™×™ ×©×¨×”": "2024-11-30",
    "×ª×•×œ×“×•×ª": "2024-12-07",
    "×•×™×¦×": "2024-12-14",
    "×•×™×©×œ×—": "2024-12-21",
    "×•×™×©×‘": "2024-12-28",
    // 2025
    "××§×¥": "2025-01-04",
    "×•×™×’×©": "2025-01-11",
    "×•×™×—×™": "2025-01-18",
    "×©××•×ª": "2025-01-25",
    "×•××¨×": "2025-02-01",
    "×‘×": "2025-02-08",
    "×‘×©×œ×—": "2025-02-15",
    "×™×ª×¨×•": "2025-02-22",
    "××©×¤×˜×™×": "2025-03-01",
    "×ª×¨×•××”": "2025-03-08",
    "×ª×¦×•×”": "2025-03-15",
    "×›×™ ×ª×©×": "2025-03-22",
    "×•×™×§×”×œ-×¤×§×•×“×™": "2025-03-29",
    "×•×™×§×¨×": "2025-04-05",
    "×¦×•": "2025-04-12",
    "×©××™× ×™": "2025-04-26",
    "×ª×–×¨×™×¢-××¦×•×¨×¢": "2025-05-03",
    "××—×¨×™ ××•×ª-×§×“×•×©×™×": "2025-05-10",
    "×××•×¨": "2025-05-17",
    "×‘×”×¨-×‘×—×•×§×ª×™": "2025-05-24",
    "×‘××“×‘×¨": "2025-05-31",
    "× ×©×": "2025-06-07",
    "×‘×”×¢×œ×•×ª×š": "2025-06-14",
    "×©×œ×—": "2025-06-21",
    "×§×¨×—": "2025-06-28",
    "×—×§×ª-×‘×œ×§": "2025-07-05",
    "×¤×™× ×—×¡": "2025-07-12",
    "××˜×•×ª-××¡×¢×™": "2025-07-19",
    "×“×‘×¨×™×": "2025-07-26",
    "×•××ª×—× ×Ÿ": "2025-08-02",
    "×¢×§×‘": "2025-08-09",
    "×¨××”": "2025-08-16",
    "×©×•×¤×˜×™×": "2025-08-23",
    "×›×™ ×ª×¦×": "2025-08-30",
    "×›×™ ×ª×‘×•×": "2025-09-06",
    "× ×¦×‘×™×-×•×™×œ×š": "2025-09-13",
    "×”××–×™× ×•": "2025-09-27",
    "×•×–××ª ×”×‘×¨×›×”": "2025-10-04",
    // 2026
    "×‘×¨××©×™×ª-2026": "2025-10-24",
    "× ×—-2026": "2025-10-31",
    "×œ×š ×œ×š-2026": "2025-11-07",
    "×•×™×¨×-2026": "2025-11-14",
    "×—×™×™ ×©×¨×”-2026": "2025-11-21",
    "×ª×•×œ×“×•×ª-2026": "2025-11-28",
    "×•×™×¦×-2026": "2025-12-05",
    "×•×™×©×œ×—-2026": "2025-12-12",
    "×•×™×©×‘-2026": "2025-12-19",
    "××§×¥-2026": "2025-12-26",
    "×•×™×’×©-2026": "2026-01-02",
    "×•×™×—×™-2026": "2026-01-09",
    "×©××•×ª-2026": "2026-01-16",
    "×•××¨×-2026": "2026-01-23",
    "×‘×-2026": "2026-01-30"
};

function formatHebrewDate(dateStr) {
    if (!dateStr) return '--';
    
    const date = new Date(dateStr);
    const day = date.getDate();
    const months = ['×™× ×•××¨', '×¤×‘×¨×•××¨', '××¨×¥', '××¤×¨×™×œ', '×××™', '×™×•× ×™', 
                   '×™×•×œ×™', '××•×’×•×¡×˜', '×¡×¤×˜××‘×¨', '××•×§×˜×•×‘×¨', '× ×•×‘××‘×¨', '×“×¦××‘×¨'];
    const month = months[date.getMonth()];
    const year = date.getFullYear();
    
    return `${day} ${month} ${year}`;
}

function showAddCalibrationDialog() {
    const select = document.getElementById('modalParsha');
    select.innerHTML = '<option value="">×‘×—×¨ ×¤×¨×©×”...</option>';

    Object.keys(PARSHIOT).forEach(parsha => {
        const option = document.createElement('option');
        option.value = parsha;
        option.textContent = parsha;
        select.appendChild(option);
    // ××™×•×Ÿ ×”×¤×¨×©×•×ª ×œ×¤×™ ×ª××¨×™×š (××”×—×“×© ×œ×™×©×Ÿ)
    const sortedParshiot = Object.keys(PARSHA_DATES)
        .sort((a, b) => new Date(PARSHA_DATES[b]) - new Date(PARSHA_DATES[a]));
    
    sortedParshiot.forEach(parsha => {
        // ×”×¡×¨ ×¡×™×•××ª -2026 ××”×ª×¦×•×’×”
        const displayName = parsha.replace('-2026', '');
        const verses = PARSHIOT[displayName] || PARSHIOT[parsha];
        
        if (verses) {
            const option = document.createElement('option');
            option.value = parsha;
            option.textContent = displayName + ' (' + formatHebrewDate(PARSHA_DATES[parsha]) + ')';
            select.appendChild(option);
        }
    });

    document.getElementById('modalDate').value = '';
    document.getElementById('modalPredicted').value = '';
    document.getElementById('modalDateDisplay').textContent = '--';
    document.getElementById('modalPredictedDisplay').textContent = '--:--';
    document.getElementById('modalActual').value = '';

    document.getElementById('addCalibrationModal').classList.add('active');
}

function closeAddCalibrationModal() {
    document.getElementById('addCalibrationModal').classList.remove('active');
}

function updateModalFields() {
    const parsha = document.getElementById('modalParsha').value;

    if (!parsha) {
        document.getElementById('modalDate').value = '';
        document.getElementById('modalPredicted').value = '';
        document.getElementById('modalDateDisplay').textContent = '--';
        document.getElementById('modalPredictedDisplay').textContent = '--:--';
        return;
    }

    const date = PARSHA_DATES[parsha] || new Date().toISOString().split('T')[0];
    document.getElementById('modalDate').value = date;
    // ×”×¦×’ ×ª××¨×™×š ××¢×•×¦×‘
    const date = PARSHA_DATES[parsha];
    document.getElementById('modalDateDisplay').textContent = formatHebrewDate(date);

    const verses = PARSHIOT[parsha];
    if (!verses) return;
    // ×—×©×‘ ×—×™×–×•×™
    const displayName = parsha.replace('-2026', '');
    const verses = PARSHIOT[displayName] || PARSHIOT[parsha];
    
    if (!verses) {
        document.getElementById('modalPredictedDisplay').textContent = '×©×’×™××”';
        return;
    }

    const category = getCategory(verses);
    const categoryOffset = appData.categoryOffsets[category] || 0;

    const totalMinutes = (verses * appData.baseMinutesPerVerse) + 
                        appData.globalOffset + categoryOffset;

    const [startHour, startMin] = appData.startTime.split(':').map(Number);
    const startTotalMin = startHour * 60 + startMin;
    const endTotalMin = startTotalMin + Math.round(totalMinutes);

    const endHour = Math.floor(endTotalMin / 60);
    const endMin = endTotalMin % 60;

    const predictedTime = `${String(endHour).padStart(2, '0')}:${String(endMin).padStart(2, '0')}`;
    document.getElementById('modalPredicted').value = predictedTime;
    document.getElementById('modalPredictedDisplay').textContent = predictedTime;
}

function saveManualCalibration() {
    const parsha = document.getElementById('modalParsha').value;
    const dateDisplay = document.getElementById('modalDateDisplay').textContent;
    const predictedDisplay = document.getElementById('modalPredictedDisplay').textContent;
    const actual = document.getElementById('modalActual').value;

    if (!parsha) {
        alert('âŒ × × ×œ×‘×—×•×¨ ×¤×¨×©×”');
        return;
    }

    if (!actual) {
        alert('âŒ × × ×œ×”×–×™×Ÿ ×–××Ÿ ×—×–×¨×” ×‘×¤×•×¢×œ');
        return;
    }

    if (!/^\d{2}:\d{2}$/.test(actual)) {
        alert('âŒ ×¤×•×¨××˜ ×©×¢×” ×œ× ×ª×§×™×Ÿ!\n\n×”×©×ª××© ×‘: HH:MM (×œ×“×•×’××”: 09:47)');
        return;
    }

    const date = PARSHA_DATES[parsha];
    const [predHour, predMin] = predictedDisplay.split(':').map(Number);
    const [actHour, actMin] = actual.split(':').map(Number);
    const error = (actHour * 60 + actMin) - (predHour * 60 + predMin);

    // ×”×¡×¨ ×¡×™×•××ª -2026 ×œ×©××™×¨×”
    const displayName = parsha.replace('-2026', '');

    appData.history.push({
        date: date,
        parsha: displayName,
        predicted: predictedDisplay,
        actual: actual,
        error: error
    });

    appData.history.sort((a, b) => new Date(b.date) - new Date(a.date));
    appData.calibrationCount = appData.history.length;

    // ×—×™×©×•×‘ ××—×“×© ×©×œ ×›×œ ×”-offsets
    appData.globalOffset = 0;
    appData.categoryOffsets = { short: 0, medium: 0, long: 0, very_long: 0 };
    
    appData.history.slice().reverse().forEach(item => {
        const verses = PARSHIOT[item.parsha];
        if (verses) {
            const category = getCategory(verses);
            appData.globalOffset += item.error * 0.3;
            appData.categoryOffsets[category] += item.error * 0.2;
        }
    });

    saveData();
    updateHistory();
    updateStats();
    updateLearningDisplay();
    updatePrediction();

    closeAddCalibrationModal();

    alert(`âœ… ×›×™×•×•× ×•×Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×”!\n\n×¤×¨×©×ª ${displayName}\n×©×’×™××”: ${error > 0 ? '+' : ''}${error} ×“×§×•×ª\n\n×”×§×™×–×•×–×™× ×—×•×©×‘×• ××—×“×©!`);
}

document.addEventListener('click', function(e) {
    const modal = document.getElementById('addCalibrationModal');
    if (e.target === modal) {
        closeAddCalibrationModal();
    }
});

function saveManualCalibration() {
    const parsha = document.getElementById('modalParsha').value;
    const date = document.getElementById('modalDate').value;
    const predicted = document.getElementById('modalPredicted').value;
    const actual = document.getElementById('modalActual').value;

    if (!parsha) {
        alert('âŒ × × ×œ×‘×—×•×¨ ×¤×¨×©×”');
        return;
    }

    if (!actual) {
        alert('âŒ × × ×œ×”×–×™×Ÿ ×–××Ÿ ×—×–×¨×” ×‘×¤×•×¢×œ');
        return;
    }

    if (!/^\d{2}:\d{2}$/.test(actual)) {
        alert('âŒ ×¤×•×¨××˜ ×©×¢×” ×œ× ×ª×§×™×Ÿ!\n\n×”×©×ª××© ×‘: HH:MM (×œ×“×•×’××”: 09:47)');
        return;
    }

    const [predHour, predMin] = predicted.split(':').map(Number);
    const [actHour, actMin] = actual.split(':').map(Number);
    const error = (actHour * 60 + actMin) - (predHour * 60 + predMin);

    appData.history.push({
        date: date,
        parsha: parsha,
        predicted: predicted,
        actual: actual,
        error: error
    });

    appData.history.sort((a, b) => new Date(b.date) - new Date(a.date));

    appData.calibrationCount = appData.history.length;

    recalculateOffsets();

    saveData();
    updateHistory();
    updateStats();
    updateLearningDisplay();
    updatePrediction();

    closeAddCalibrationModal();

    alert(`âœ… ×›×™×•×•× ×•×Ÿ × ×•×¡×£ ×‘×”×¦×œ×—×”!\n\n×¤×¨×©×ª ${parsha}\n×©×’×™××”: ${error > 0 ? '+' : ''}${error} ×“×§×•×ª\n\n×”×§×™×–×•×–×™× ×—×•×©×‘×• ××—×“×©!`);
}

document.addEventListener('click', function(e) {
    const modal = document.getElementById('addCalibrationModal');
    if (e.target === modal) {
        closeAddCalibrationModal();
    }
});

function deleteHistoryItem(index) {
    const item = appData.history[index];

    if (!confirm(`×”×× ×œ××—×•×§ ××ª ×”×›×™×•×•× ×•×Ÿ?\n\n×¤×¨×©×ª ${item.parsha}\n×ª××¨×™×š: ${item.date}\n×©×’×™××”: ${item.error > 0 ? '+' : ''}${item.error} ×“×§×•×ª\n\n×©×™× ×œ×‘: ×”×§×™×–×•×–×™× ×™×—×•×©×‘×• ××—×“×©!`)) {
        return;
    }

    // ××—×™×§×ª ×”×¨×©×•××”
    appData.history.splice(index, 1);
    appData.calibrationCount = appData.history.length;

    // ×—×™×©×•×‘ ××—×“×© ×©×œ ×›×œ ×”×§×™×–×•×–×™×
    recalculateOffsets();

    // ×©××™×¨×” ×•×¢×“×›×•×Ÿ ×ª×¦×•×’×”
    saveData();
    updateHistory();
    updateStats();
    updateLearningDisplay();
    updatePrediction();

    alert('âœ… ×”×¨×©×•××” × ××—×§×” ×•×”×§×™×–×•×–×™× ×—×•×©×‘×• ××—×“×©!');
}

// ========================================
// ×¤×•× ×§×¦×™×” ×œ×¢×¨×™×›×ª ×¨×©×•××”
// ========================================

function editHistoryItem(index) {
    const item = appData.history[index];

    const newTime = prompt(
        `×¢×¨×™×›×ª ×–××Ÿ ×—×–×¨×” ×‘×¤×•×¢×œ\n\n×¤×¨×©×ª ${item.parsha} (${item.date})\n\n×–××Ÿ × ×•×›×—×™: ${item.actual}\n×”×–×Ÿ ×–××Ÿ ×—×“×© (×¤×•×¨××˜: HH:MM):`,
        item.actual
    );

    if (!newTime) return;

    if (!/^\d{2}:\d{2}$/.test(newTime)) {
        alert('âŒ ×¤×•×¨××˜ ×œ× ×ª×§×™×Ÿ! ×”×©×ª××© ×‘: HH:MM (×œ×“×•×’××”: 09:47)');
        return;
    }

    // ×—×™×©×•×‘ ×©×’×™××” ×—×“×©×”
    const [predHour, predMin] = item.predicted.split(':').map(Number);
    const [actHour, actMin] = newTime.split(':').map(Number);
    const newError = (actHour * 60 + actMin) - (predHour * 60 + predMin);

    // ×¢×“×›×•×Ÿ
    appData.history[index].actual = newTime;
    appData.history[index].error = newError;

    // ×—×™×©×•×‘ ××—×“×©
    recalculateOffsets();

    // ×©××™×¨×” ×•×¢×“×›×•×Ÿ
    saveData();
    updateHistory();
    updateStats();
    updateLearningDisplay();
    updatePrediction();

    alert(`âœ… ×”×¨×©×•××” ×¢×•×“×›× ×”!\n\n×©×’×™××” ×—×“×©×”: ${newError > 0 ? '+' : ''}${newError} ×“×§×•×ª\n×”×§×™×–×•×–×™× ×—×•×©×‘×• ××—×“×©!`);
}

// ========================================
// ×¤×•× ×§×¦×™×” ×œ×—×™×©×•×‘ ××—×“×© ×©×œ ×›×œ ×”×§×™×–×•×–×™×
// ========================================

function recalculateOffsets() {
    // ××™×¤×•×¡ ×”×§×™×–×•×–×™×
    appData.globalOffset = 0;
    appData.categoryOffsets = { short: 0, medium: 0, long: 0, very_long: 0 };

    // ××¢×‘×¨ ×¢×œ ×›×œ ×”×”×™×¡×˜×•×¨×™×” ××”×¡×•×£ ×œ×”×ª×—×œ×” (××”×™×©×Ÿ ×œ×—×“×©)
    const reversedHistory = [...appData.history].reverse();

    for (const item of reversedHistory) {
        // ×“×™×œ×•×’ ×¢×œ ×”×›×™×•×•× ×•×Ÿ ×”×¨××©×•× ×™ (×•×™×¨×)
        if (item.notes === "Initial calibration") continue;

        // ×—×™×©×•×‘ ×§×˜×’×•×¨×™×”
        const verses = PARSHIOT[item.parsha];
        if (!verses) continue;

        const category = getCategory(verses);
        const errorMinutes = item.error;

        // ×¢×“×›×•×Ÿ ×§×™×–×•×–×™×
        const GLOBAL_RATE = 0.3;
        const CATEGORY_RATE = 0.2;

        appData.globalOffset += errorMinutes * GLOBAL_RATE;
        appData.categoryOffsets[category] += errorMinutes * CATEGORY_RATE;
    }
}

// ========================================
// ×”×•×¡×£ ××ª ×”×¤×•× ×§×¦×™×•×ª ×”××œ×” ×œ×¤× ×™ window.addEventListener
// ========================================

        function updateParshiotList() {
            const parshiotList = document.getElementById('parshiotList');
            const parshiotByBook = {
                '×‘×¨××©×™×ª': ['×‘×¨××©×™×ª', '× ×—', '×œ×š ×œ×š', '×•×™×¨×', '×—×™×™ ×©×¨×”', '×ª×•×œ×“×•×ª', '×•×™×¦×', '×•×™×©×œ×—', '×•×™×©×‘', '××§×¥', '×•×™×’×©', '×•×™×—×™'],
                '×©××•×ª': ['×©××•×ª', '×•××¨×', '×‘×', '×‘×©×œ×—', '×™×ª×¨×•', '××©×¤×˜×™×', '×ª×¨×•××”', '×ª×¦×•×”', '×›×™ ×ª×©×', '×•×™×§×”×œ', '×¤×§×•×“×™', '×•×™×§×”×œ-×¤×§×•×“×™'],
                '×•×™×§×¨×': ['×•×™×§×¨×', '×¦×•', '×©××™× ×™', '×ª×–×¨×™×¢', '××¦×•×¨×¢', '×ª×–×¨×™×¢-××¦×•×¨×¢', '××—×¨×™ ××•×ª', '×§×“×•×©×™×', '××—×¨×™ ××•×ª-×§×“×•×©×™×', '×××•×¨', '×‘×”×¨', '×‘×—×•×§×ª×™', '×‘×”×¨-×‘×—×•×§×ª×™'],
                '×‘××“×‘×¨': ['×‘××“×‘×¨', '× ×©×', '×‘×”×¢×œ×•×ª×š', '×©×œ×—', '×§×¨×—', '×—×§×ª', '×‘×œ×§', '×—×§×ª-×‘×œ×§', '×¤×™× ×—×¡', '××˜×•×ª','××¡×¢×™', '××˜×•×ª-××¡×¢×™'],
                '×“×‘×¨×™×': ['×“×‘×¨×™×', '×•××ª×—× ×Ÿ', '×¢×§×‘', '×¨××”', '×©×•×¤×˜×™×', '×›×™ ×ª×¦×', '×›×™ ×ª×‘×•×', '× ×¦×‘×™×', '×•×™×œ×š', '× ×¦×‘×™×-×•×™×œ×š', '×”××–×™× ×•', '×•×–××ª ×”×‘×¨×›×”']
            };
            let html = '';
            for (const [book, parshiot] of Object.entries(parshiotByBook)) {
                html += `<div class="learning-progress" style="margin-bottom: 15px;"><div class="learning-title">ğŸ“˜ ${book}</div>`;
                parshiot.forEach(parsha => {
                    const verses = PARSHIOT[parsha];
                    if (verses) {
                        const isCurrent = parsha === currentParsha;
                        html += `<div class="offset-item" style="${isCurrent ? 'background: #e3f2fd; font-weight: bold;' : ''}"><span class="offset-label">${isCurrent ? 'ğŸ‘‰ ' : ''}${parsha}</span><span class="offset-value">${verses} ×¤×¡×•×§×™×</span></div>`;
                    }
                });
                html += `</div>`;
            }
            parshiotList.innerHTML = html;
        }

        function updateStats() {
            document.getElementById('totalCalibrations').textContent = appData.calibrationCount;
            if (appData.history.length > 0) {
                const avgError = Math.abs(appData.history.reduce((sum, item) => sum + Math.abs(item.error), 0) / appData.history.length).toFixed(1);
                document.getElementById('avgError').textContent = avgError;
            } else {
                document.getElementById('avgError').textContent = '0';
            }
        }

        function saveSettings() {
            appData.startTime = document.getElementById('startTime').value;
            saveData();
            updatePrediction();
        }

        function resetData() {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×›×œ ×”× ×ª×•× ×™×?\n\n×–×” ×™××—×§ ××ª ×›×œ ×”×›×™×•×•× ×•× ×™× ×•×”×”×™×¡×˜×•×¨×™×”!')) {
                localStorage.removeItem('shabbatReturnData');
                appData = {
                    baseMinutesPerVerse: 0.918,
                    globalOffset: 0,
                    categoryOffsets: { short: 0, medium: 0, long: 0, very_long: 0 },
                    startTime: "08:00",
                    history: [],
                    calibrationCount: 0,
                    savedParsha: null,
                    savedParshaDate: null
                };
                init();
                alert('âœ… ×”× ×ª×•× ×™× ××•×¤×¡×• ×‘×”×¦×œ×—×”');
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('calibrateTab').classList.add('hidden');
            document.getElementById('historyTab').classList.add('hidden');
            document.getElementById('parshiotTab').classList.add('hidden');
            document.getElementById('settingsTab').classList.add('hidden');
            if (tab === 'calibrate') {
                document.getElementById('calibrateTab').classList.remove('hidden');
            } else if (tab === 'history') {
                document.getElementById('historyTab').classList.remove('hidden');
                updateHistory();
            } else if (tab === 'parshiot') {
                document.getElementById('parshiotTab').classList.remove('hidden');
                updateParshiotList();
            } else if (tab === 'settings') {
                document.getElementById('settingsTab').classList.remove('hidden');
                updateStats();
            }
        }

        function init() {
            loadData();
            document.getElementById('startTime').value = appData.startTime;
            updateLearningDisplay();
            updateHistory();
            updateStats();
            loadCurrentParsha();
        }

        window.addEventListener('DOMContentLoaded', init);

    </script>

<div class="modal-overlay" id="addCalibrationModal">
        <div class="modal-content">
            <div class="modal-header">â• ×”×•×¡×£ ×›×™×•×•× ×•×Ÿ ×™×©×Ÿ</div>
            
            <div class="modal-input-group">
                <label for="modalParsha">×¤×¨×©×ª ×”×©×‘×•×¢</label>
                <select id="modalParsha" onchange="updateModalFields()">
                    <option value="">×‘×—×¨ ×¤×¨×©×”...</option>
                </select>
                <div class="info-text">×‘×—×¨ ××ª ×”×¤×¨×©×” ×©×‘×¨×¦×•× ×š ×œ×›×™×™×œ</div>
            </div>
    <div class="modal-content">
        <div class="modal-header">â• ×”×•×¡×£ ×›×™×•×•× ×•×Ÿ ×™×©×Ÿ</div>
        
        <div class="modal-input-group">
            <label for="modalParsha">×¤×¨×©×ª ×”×©×‘×•×¢</label>
            <select id="modalParsha" onchange="updateModalFields()">
                <option value="">×‘×—×¨ ×¤×¨×©×”...</option>
            </select>
            <div class="info-text">×‘×—×¨ ××ª ×”×¤×¨×©×” ×©×‘×¨×¦×•× ×š ×œ×›×™×™×œ</div>
        </div>

            <div class="modal-input-group">
                <label for="modalDate">×ª××¨×™×š ×”×©×‘×ª</label>
                <input type="date" id="modalDate" class="readonly-field" readonly>
                <div class="info-text">×”×ª××¨×™×š ××ª××œ× ××•×˜×•××˜×™×ª</div>
            </div>
        <div class="modal-input-group">
            <label>×ª××¨×™×š ×”×©×‘×ª</label>
            <div class="display-field" id="modalDateDisplay">--</div>
            <div class="info-text">×”×ª××¨×™×š ××ª××œ× ××•×˜×•××˜×™×ª</div>
        </div>

            <div class="modal-input-group">
                <label for="modalPredicted">×—×™×–×•×™ (×–××Ÿ ××©×•×¢×¨)</label>
                <input type="time" id="modalPredicted" class="readonly-field" readonly>
                <div class="info-text">×”×—×™×–×•×™ ××—×•×©×‘ ××•×˜×•××˜×™×ª ×œ×¤×™ ×”××¢×¨×›×ª</div>
            </div>
        <div class="modal-input-group">
            <label>×—×™×–×•×™ (×–××Ÿ ××©×•×¢×¨)</label>
            <div class="display-field" id="modalPredictedDisplay">--:--</div>
            <div class="info-text">×”×—×™×–×•×™ ××—×•×©×‘ ××•×˜×•××˜×™×ª ×œ×¤×™ ×”××¢×¨×›×ª</div>
        </div>

            <div class="modal-input-group">
                <label for="modalActual">×–××Ÿ ×—×–×¨×” ×‘×¤×•×¢×œ *</label>
                <input type="time" id="modalActual" placeholder="09:47" required>
                <div class="info-text">×”×–×Ÿ ××ª ×”×–××Ÿ ×©×‘×• ×‘×¤×•×¢×œ ×—×–×¨×ª ××‘×™×ª ×”×›× ×¡×ª</div>
            </div>
        <div class="modal-input-group">
            <label for="modalActual">×–××Ÿ ×—×–×¨×” ×‘×¤×•×¢×œ *</label>
            <input type="time" id="modalActual" placeholder="09:47" required>
            <div class="info-text">×”×–×Ÿ ××ª ×”×–××Ÿ ×©×‘×• ×‘×¤×•×¢×œ ×—×–×¨×ª ××‘×™×ª ×”×›× ×¡×ª</div>
        </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeAddCalibrationModal()">
                    âŒ ×‘×™×˜×•×œ
                </button>
                <button class="modal-btn modal-btn-primary" onclick="saveManualCalibration()">
                    ğŸ’¾ ×©××•×¨
                </button>
            </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-secondary" onclick="closeAddCalibrationModal()">
                âŒ ×‘×™×˜×•×œ
            </button>
            <button class="modal-btn modal-btn-primary" onclick="saveManualCalibration()">
                ğŸ’¾ ×©××•×¨
            </button>
        </div>
    </div>
</div>

</body>
</html>
